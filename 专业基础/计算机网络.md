
教程视频(笔记主要内容):  
<a style="text-decoration: none" href="https://www.bilibili.com/video/BV19E411D78Q">王道计算机考研-计算机网络(B站)</a>  

# 概述

## 概念

计算机网络:  
一个将分散的, 具有独立功能的**计算机系统**, 通过**通信设备**与**线路**连接起来, 由功能完善的**软件**实现 **资源共享** 和 **信息传递** 的系统.  

计算机网络的精确定义并未统一, 仅做参考.  

互联网:  
互联网, 是全球最大的 "互连网".  
由数量极大的各种计算机网络互连起来, 其覆盖全球.  
互联网有两个基本特点: 连通性 和 共享.  

互连网, 泛指由多个计算机网络互连而成的计算机网络.  


## 多层次ISP结构


多层次ISP结构由三级结构发展而来.  

三级结构:  
如果想要让所有用户都可以相互通信, 依靠个人或是小团体是无法做到的. 需要巨大的投资.  
所以有了地区网和主干网, 地区网连接校园网或企业网.  

多层次ISP结构:  
1993, 美国政府互联网的运营逐渐被商用互联网主干代替, 其被称为**互联网服务提供者(ISP)**, 或是 **互联网提供商**. 我国的有电信, 移动, 联通.  
ISP 会为用户提供 IP地址, 来提供服务.  

互联网结构:  
![互联网结构](https://pic.imgdb.cn/item/65200598c458853aefcde91f.png)

- 互联网交换点(IXP):  
	使ISP之间能直接相连, 交换信息, 无需经过更高层的节点.  
	加快信息流通速度.  


## 组成与分类

### 计算机网络的组成

从工作方式上可分为: 边缘部分, 核心部分.  

- 边缘部分:  
	由所有连接在互联网上的主机组成. 可由用户直接使用, 进行(进程)通信和资源共享.  

通信方式:  
计算机之间通信一般指, 不同计算机的进程之间通信.  

- 客户-服务器方式:  
	client-server, (C/S).  
	客户发送请求, 服务器提供服务.  

- 对等连接方式:  
	peer-to-peer, (P2P).  
	并不区分请求方与提供方, 只要运行对等连接软件(P2P软件), 就可以进行平等的通信. 双方都可以下载已储存在对方硬盘中的共享文件.  


- 核心部分:  
	由大量网络和连接这些网络的路由器组成. 为边缘部分提供服务.  
	其为互联网中最复杂的部分. 由 **路由器(router)**, 一种专用计算机, 实现分组交换.  

- 电路交换:  
	在数据传输期间, 源结点与目的结点之间有一条由中间结点构成的专用物理连接线路, <span>在数据传输结束前, 一直保持占用</span>.  
	过程:  
	建立连接 -> 通信 -> 释放连接  

- 报文交换:  
	需要发送的整块数据称为一个 **报文(message)**, 将其作为数据交换的单位.  
	报文会被一次性接收, 储存, 转发.  

- 分组交换:  
	将报文分成若干段, 加上首部, 构成一个 **分组(packet)**, 又称 **包**.  
	分组即互联网传送中的数据单元.  
	路由器会暂存分组, 确定路线, 将其转发给下一个路由器, 最后进行组装.  


### 计算机网络的分类

- 按照网络的作用范围分:  
	- 广域网(WAN): 几十到几千公里, 跨国网络.  
	- 城域网(MAN): 用来将多个局域网进行互连.  
	- 局域网(LAN): 一般用高速通信线路相连, 但局限在较小范围(如1km).  
	- 个人区域网(PAN): 将个人使用的电子设备用无线技术连接起来的网络, 其范围约为10m.  
	
	广域网与局域网的技术并不相同. 广域网使用交换技术, 局域网使用广播技术.  


- 按使用者分:  
	- 公用网
	- 专用网


## 网络的性能指标

- 速率:  
	指数据的传送速率, 也称数据率, 比特率.  
	单位: bit/s, bps.  
	速率的 k, M, G, T 之间以 10^3 为倍数, 而不是 2^10.  

- 带宽:  
	带宽本来指某个信号具有的频带宽度, 即频率范围的宽度.  
	在计算机网络中, 带宽指网络中某通道的传送数据的能力, 表示其**最高数据率**, 单位为 bps.  

- 吞吐量:  
	表示单位时间内通过某个网络的实际数据量.  
	吞吐量受到带宽或额定速率的限制.  

- 时延:  
	指数据从网络的一端传送到另一端所需的时间. 也称为延迟, 迟延.  

	- 发送时延: 主机或路由器发送数据帧所需要的时间.  
		发送时延 = 数据帧长度(bit)/发送速率(bps)  

	- 传播时延: 电磁波在信道中传播需要一定时间.  
		传播时延 = 信道长度(m)/传播速率(m/s)  
		光纤中的速率约为 2.0 x 10^5 km/s  

	- 处理时延:  
		主机或路由器在收到分组时要花费一定时间来处理.  

	- 排队时延:  
		分组在进入路由器后需要进行排队等待处理.  


- 时延带宽积:  
	时延带宽积 = 传播时延 x 带宽  
	其表示链路满载时, 其中的数据量.  


- 往返时间 RTT:  
	从发送数据开始, 到发送方收到接收方的确认的时间.  


- 利用率:  
	- 信道利用率: 指信道有多少比例的时间是在被利用的(有数据通过).  
	- 网络利用率: 为全网络的信道利用率的加权平均值.  
	
	由于有处理/排队时延, 所以网络的时延会随利用率的增加而增加.  


## 计算机网络体系结构

分层次的体系结构(架构)是最基本的.  

为什么要分层:  
- 发送文件需要完成的工作:  
	1. 发起通信的计算机必须将数据通信的通路进行**激活**.  
	2. 告诉网络如何识别接收数据的主机.  
	3. 发起通信的计算机必须查明对方计算机是否开机, 并与网络正常连接.  
	4. 发起通信的计算机要知道对方是否准备好接收并储存文件.  
	5. 如果格式不兼容, 需要格式转换功能.  
	6. 确保差错和意外可以解决.  

为了能进行如此复杂的协调工作, 需要进行分层处理.  
各层之间独立, 对上层提供服务的接口, 进行分工合作.  

<br>

- 协议:  
	为了进行网络中的数据交换而建立的**规则, 标准, 约定**称为**网络协议**, 简称 协议.  
	
	网络协议由三个要素组成:  
	- 语法, 即数据与控制信息的结构或格式.  
	- 语义, 即需要发出何种控制信息, 完成何种动作以及做出何种响应.  
	- 同步, 即事件实现顺序的详细说明.  


计算机网络的各层及其协议的集合就是网络的体系结构.  


### 具有五层协议的体系结构


OSI 的七层协议体系结构的概念清楚, 理论较为完整, 但既复杂又不实用.  
TCP/IP 为四层的体系结构, 得到了非常广泛的应用.  
在讲述网络的原理时, 采用五层协议的体系结构.  

计算机网络体系结构:  
![...](https://pic.imgdb.cn/item/652005eec458853aefce542e.png)
> TCP/IP 的网络接口层(链路层) 并没有具体内容, 只要能连上上层的网际层接口即可.  
> 七层中上三层为数据处理, 下三层为数据通信.  


- 应用层:  
	应用层的任务是通过应用进程间的交互来完成特定网络应用.  
	应用层协议定义的是应用进程间通信和交互的规则.  
	应用层协议有 DNS, HTTP, SMTP等.  
	应用层交互的数据单位称为**报文(message)**.  

---  

- 运输层:  
	负责向两台主机中进程之间的通信提供**通用的数据传输服务**.  
	多种应用可以使用同一个运输层服务, 运输层具有分用与复用的功能.  
	运输层协议主要有:  
	- 传输控制协议(TCP): 提供面向连接的, 可靠的数据传输服务, 数据传输单位为**报文段(segment)**.  
	- 用户数据报协议(UDP): 提供无连接的尽最大努力的数据传输服务(不保证数据传输的可靠性), 传输单位为**用户数据报**.  

---  

- 网络层:  
	负责为分组交换网上的不同主机提供通信服务.  
	会将运输层的数据封装成**分组**或**包**, 也称 **IP数据报**.  
	具体任务:  
	- 通过一定算法, 在互联网中的每一个路由器上生成一个转发表, 标明目的地和下一站.  
	- 每个路由器在接收到一个分组时, 依据转发表中指明的路径将其转发给下一个路由器.  

---  

- 数据链路层:  
	简称链路层.  
	在网络中相邻两个节点之间传送数据时, 数据链路层将网络层交下来的(IP)数据报组装成**帧**, 进行传送. 每帧包括数据和必要的控制信息(同步, 地址, 校验).  

---  

- 物理层:  
	负责传送接收比特信息(0, 1)的物理信号.  
	其定义了电子信息的物理表示形式, 以及物理设备接口的规格等.  
	传递信息所用的物理传输媒体(电缆, 光缆, 无线信道)并不在物理层之内, 而是属于物理传输媒体层.  

数据在各层的传递过程:  
![数据在各层的传递过程](https://pic.imgdb.cn/item/6520062fc458853aefce8b43.png)

<br>

# 物理层

物理层解决如何在连接各种计算机的传输媒体上**传输数据比特流**, 而不是指具体的传输媒体.  
主要任务: 确定与传输媒体接口有关的一些特性(定义标准).  

- 机械特性:  
	定义物理连接的特性, 规定物理连接时所采用的规格, 接口形状, 引线数量和排列情况.  

- 电气特性:  
	规定传输二进制位时, 路线上信号的电压范围, 阻抗匹配, 传输速率和距离限制等.  

- 功能特性:  
	指明某条线上出现的某一电平表示何种意义, 接口部件的信号线的用途.  

- 规程(过程)特性:  
	定义各条物理路线的工作规程和时序关系.  


## 数据通信基础知识


- 典型的数据通信模型:  
![][https://pic.imgdb.cn/item/65200667c458853aefce944f.png]

- 数据通信相关术语:  
	- 数据(data): 传送信息的实体, 通常为有意义的符号序列.  
	- 信号: 数据的电气/电磁的表现, 是数据在传输过程中的存在形式.  
		数字/离散信号: 消息的参数取值为离散的.  
		模拟/连续信号: 消息的参数取值为连续的.  
	- 信源: 产生和发送数据的源头.  
	- 信宿: 接收数据的终点.
	- 信道: 信号的传输媒介. 一条通信线路一般包含一条发送信道和一条接收信道.  

- 三种通信方式:  
	- 单工通信:  
		只有一个反向的通信而没有反向的交互, 仅需要一条信道.  
	- 半双工通信/双向交替通信:  
		通信的双方都可以发送或接收信息, 但不能同时发送.  
	- 全双工通信/双向同时通信:  
		通信双方可以同时发送和接收信息, 需要两条信道.  

- 数据传输方式:  
	- 串行传输: 逐个发送数据比特.  
	- 并行传输: 同时发送多个比特, 需要多条信道.  

- 码元:  
	指一个**固定时长**的**信号波形**(数字脉冲), 代表不同离散数值的基本波形, 是数字通信中数字信号的计量单位, 这个时长内的信号称为 k进制码元, 而该时长称为码元宽度. 当码元的离散状态有 M 个时(M > 2), 此时码元为M进制码元.  
	当一个码元有 n bit 时, 其为 M = 2^n 进制码元.  

-  传输速率:  
	- 码元传输速率: 单位时间内传输的码元个数, 单位为 波特(B), 随码元长度变化.  
	- 信息传输速率: 单位时间内传输的二进制码元个数(即比特数), 单位为比特/秒(b/s).  


## 奈氏准则和香农定理☆


- 失真:  
	信号在信道上传输时会难以避免地产生失真.  
	过于严重时会导致无法识别(复原).  
	传输速率越高, 信号传输距离越远, 噪声干扰越大, 传输媒体质量越差, 失真越严重.  

- 码间串扰:  
	一个信道所能通过的频率范围是有限的, 低频经过衰减/干扰难以通过, 高频会产生码间串扰.  
	码间串扰: 频率过高, 接收端收到的信号波形失去了码元之间的**清晰界限**.  

- 奈氏准则:  
	在理想低通(无噪声, 带宽受限)条件下, 为了避免码间串扰, 极限码元传输速率为 2W Baud(波特), W 为信道带宽, 单位: Hz.  
	极限数据率: $2W \log_{2}V$, V 为码元个数(种类数).  

- 信噪比:  
	噪声是随机产生的, 噪声的影响取决于信号自身的强度与噪声的强度.  
	所以信噪比很重要, 为其平均功率之比.  
	$信噪比(dB) = 10 \log_{10}(S/N)$  

- 香农定理:  
	在带宽受限且有噪声的信道中, 信道的极限信息传输速率:  
	$C = W \log_{2}( 1+ S/N ) 　 (bit/s)$  


奈氏准则与香农定理的意义不同, 前者是为了避免码间串扰, 后者强调噪声影响.  
实际的最大传输速率需要在两个中取较小值.  


## 编码与调制


- 基带信号与宽带信号:  
	- 基带信号:  
		<span style="color:orange">没有经过调制(频谱搬移和变换)的原始电信号</span>, 通俗的讲, 基带信号就是发出的直接表达了要传输的信息的信号, 如声波.  
		将数字信号(1和0)直接用两种不同的电压表示, 再送到数字信道上传输(**基带传输**). 	

	- 宽带信号:  
		<span style="color:orange">将基带信号进行调制后形成的频分复用模拟信号</span>, 在送到模拟信道上传输(**宽带传输**).  
		基带信号经过**载波调制**后, 把信号的频率范围移至较高的频段以便能通过信号传输.  

	传输距离较**近**时, 计算机网络采用**基带传输**的方式; 较**远**时, 采用**宽带传输**的方式.  


数据 -> 编码 -> 数字信号  
数据 -> 调制 -> 模拟信号  

数字数据 -> 数字发送器 -> 数字信号
数字数据 -> 调制器 -> 模拟信号  

模拟数据 -> PCM编码器 -> 数字信号  
模拟数据 -> 放大器调制器 -> 模拟信号  


### 编码


- 不归零制:  
	正电平为 1, 负电平为 0.  
	多个连续的相同的信号没有区分, 需要时钟信号来进行同步, 确定信号间的间隔. 一般不采用此方式.  

- 归零制:  
	正负电平发出后会进行归零.  

- 曼彻斯特编码:  
	周期中心时向上跳变(上升边沿)为0, 向下跳变(下降边沿)为 1. 也可以相反.   

- 差分曼彻斯特编码:  
	周期中心都会有跳变, 开始边界有跳变为 0, 没有则为 1 (同一异零). 

曼彻斯特编码的信号频率比不归零制高, 传输信号的速率降低.  
但其周期中心的跳变使其有自同步能力.  


### 调制

数字调制技术: 将数字信号转换为模拟信号.  

- 调幅:  
	0, 1 分别为无振幅, 有振幅.  
- 调频:  
	0, 1 频率分别为 $f_1, f_2$.  
- 调相:  
	0, 1 载波的初始相位分别为 0, $\pi$.  

通过区分更多的振幅, 频率, 相位, 振幅相位混合调制(正交振幅调制, QAM)可以携带更多的比特信息.  
例如, 分为 4 个振幅, $\varphi_1, .., \varphi_4$ 分别代表 00, 01, 10 ,11.  
但其识别的难度更大, 抗干扰能力更弱.  

信号调制:  
![](https://pic.imgdb.cn/item/6520068fc458853aefce9ae9.png)

- 解调:  
	对模拟信号进行采样, 将连续的信号转为离散的信号, 实现数字化.  
	为了确保无失真: $f_{采样频率} > 2f_{信号最高频率}$.  
	采样转为数字信号后(量化)将其转换为对应的二进制编码.  


## 传输媒体

也称**传输介质**, **传输媒介**.  

其不属于物理层.  

可分为两大类:  
- 导引型传输媒体.  
- 非导引型传输媒体.  
其区别为是否有固定的固体媒介进行传播.  


- 导引型:  
	- 双绞线:  
		最古老, 最常用的传输媒体.  
		将两根互相绝缘的铜导线并排放置, 相互绞合, 缠绕.  
		这样可以减少对相邻导线的电磁干扰.  
		还可以再增加屏蔽层(屏蔽双绞线).  
	
	- 同轴电缆:  
		由导体铜制芯线, 绝缘层, 网状编织的屏蔽层, 塑料外壳构成.  
		曾在局域网发展初期广泛使用, 目前主要用在有线电视网的居民校区中.  
	
	- 光缆:  
		利用光导纤维(光纤)传递光脉冲进行通信, 光纤通信的传输带宽远高于目前其它传输媒体的带宽.  
		其主要由**纤芯**和**包层**构成双层通信圆柱体, 纤芯很细(8 - 100 微米), 光在其中进行全反射前进.  
	
		- 多模光纤:  
			多条不同入射角的光线在一条光纤中传输.  
			只适合近距离传输.  
		- 单模光纤:  
			直径更细(几微米), 采用激光器而非发光二极管, 损耗小, 可以传输更远.  
	
		光纤连包层一起的直径也不到 0.2mm, 通常会将几十几百根一起做成光缆, 外加一些加强芯和填充物, 提高机械强度.  

- 非导引型:  
	- 无线电波:  
		球形传播方向, 有较强穿透力, 可远距离传输, 广泛用于通信领域(移动通信).  
	- 微波:  
		直线传播, 由于地表为曲面, 传输距离只有50-100km, 需要中继.  

	- 红外线, 激光:  
		用于近距离的笔记本电脑相互传送数据.   


## 物理层设备


- 中继器:  
	- 诞生的原因:  
		由于存在损耗, 在线路上传输的信号功率会逐渐衰减, 可能会导致失真.  
	- 功能:  
		对信号进行**再生和还原**, 对衰减的信号进行放大, 保持与原数据相同, 以增加信号传输的距离.  
	- 中继器的两端:  
		两端的网络部分是网段, 而不是子网, 适用于完全相同的两类网络的互连, 且两个网段速率要相同.  
		它仅作用于信号的电气部分, 并不管数据是否有错误或是不适于网段的数据.  
		中继器两端的网段一定要是同一个协议.  

- 集线器(多口中继器):  
	- 再生, 放大信号.  


## 信道复用技术

[静态划分信道](#静态划分信道)  


# 数据链路层

## 概述


数据链路层使用的信道主要有:  
- 点对点信道.  
- 广播信道.  

广播信道即多个站点连接在总线上, 共用总线传输, 也就需要"总线控制".  

对数据链路的研究, 一般就认为是数据在水平的数据链路层上传输.  

三个基本问题: 封装成帧, 透明传输, 差错检测.  

基本服务: 将源自网络层来的数据**可靠地**传输到相邻节点的目标机网络层.  
主要作用: 加强物理层传输原始比特流的功能, 将物理层提供的可能出错的物理连接改造为**逻辑上无差错的数据链路**, 使之对网络层表现为一条无差错的链路.  

点对点协议(PPP), 是目前使用的最广泛的数据链路层协议.  


## 封装成帧与透明传输


- 帧:  
	
	即在数据的前后添加首部, 尾部, 构成一个帧.  
	帧, 为数据链路层的数据传送单元.  
	其首部/尾部作为帧的边界判定, 也包含一些控制信息.  
	虽然为了效率, 数据部分应该越大越好, 但链路层有规定数据部分长度上限--最大传送单元(MTU).  


- 透明传输:  
	
	因为帧的首部, 尾部用作其边界的判定(标记), 所以传输的数据内容应不允许出现与判断标记相同的比特组合.  
	
	**无论怎样的比特组合都能进行传输, 这就称为 "透明传输".**  

	- 字节填充(字符填充):  
		SOH, 首部的开始字符.  
		EOT, 尾部的结束字符.  
		
		在使用 ASCII 码进行传输时, 标记不在其编码中, 不会误判.  
		但其他数据(程序, 图像)却有误判的可能.  
		
		因此, 会在数据中出现的 SOH, EOT 前插入一个 转义字符(ESC), 使其不被识别为边界的标记.  
		如果数据中需要传输"ESC", 也只要在其前面再插入一个 "ESC".  
	
	
	- 零比特填充法:  
		帧的开始, 结束标记相同, 都为: 01111110. (1 * 6).  
		数据处理: 在数据中, 如果遇到五个连续的 1, 在其后面添加一个 0.  
		在接收到数据后取出帧, 将所有的五个 1 后面的 0 去除即可得到原始数据.  


## 差错检测


- 差错的产生:  
	信道中的噪声会导致传输数据产生差错.  
	
- 循环冗余检验(CRC):  
	将数据分成等长的若干组, 在其后添加 n 位冗余码(帧检验序列, FCS).  
	事先商定一个除数 P, 用 **"模2运算"** 得到余数(先在数据后添加n位0).  
	将原先添加的 0 替换为得到的余数.  
	**FCS 位数 = 除数(生成多项式)位数 - 1**.  
	
	接收方得到数据后同样进行 模2运算, 得到余数为 0, 则表示未出错.  
	出错后余数仍为 0 的概率非常小.  

- 模2运算:  
	各位进行异或运算, 得到结果后接上后一位(补至相同位数), 继续异或.  
	类似于 除法, 将减法的过程替换为异或运算.  

- 生产多项式(除数):  
	除数 P = abcd...($n_1 n_2 n_3 n_4 \dots$) 可以用多项式表示:  
	P(x) = $ax^3 + bx^2 + cx + d$ ( $n_4 x^3 + n_3 x^2 + n_2 x + n_1$ )  
	一般会省略系数为 0 的项.  


- 纠错编码(海明码/汉明码):  
	不仅可以发现错误, 还可以进行纠错.  
	[汉明码校验](计算机组成原理.md#存储器的校验)  
	[(硬件茶谈-bili)内存纠错科普](https://www.bilibili.com/video/BV1GF411V7sC)  


## 流量控制与可靠传输机制☆


发送与接收速度不匹配会造成传输出错.  

- 停止-等待协议:  
	每发送完一个帧就停止发送, 等待对方的确认, 在收到确认后再发送下一个帧.  

- 滑动窗口协议:  
	发送端有 n(8) 个连续的滑动窗口, 发送端会一直发送窗口内的数据帧, 但到最后一个窗口时会停下.  
	接收端接收到一帧后返回一个确认帧.  
	发送端收到确认帧后滑动窗口集体后移一格.  

窗口滑动协议:  
![滑动窗口协议](https://pic.imgdb.cn/item/652006d9c458853aefceb8d0.png)

停止-等待 协议也可以视为特殊(1个发送端口)的滑动窗口协议.  
滑动窗口又可以分为 **后退n帧协议(GBN)** 和 **选择重传协议(SR)**.  

|   协议    | 发送窗口大小 | 接收窗口大小 |
|:---------:|:------------:|:------------:|
| 停止-等待 |     = 1      |     = 1      |
|  后退N帧  |     > 1      |     = 1      |
| 选择重传  |     > 1      |     > 1      |

<span style="color:cornflowerblue;">随着通信链路质量的提升, 出错的概率大大降低, 这些协议可以上移至传输层, 链路层只负责差错的控制.</span>  


### 停止-等待协议


停等协议.  

停等协议是为了解决 比特出错, 丢包(在不同层次丢失的对象不同)等问题, 实现流量控制而诞生的.  

发送方发送完一个帧后停止发送, 等待接收方返回的确认帧(ACK)再继续发送.  

确认帧: ACK.  

出现各种差错时:  

- 丢包:  
	数据帧丢失时, 发送方会一直收不到确认帧, 一直无法发送下一帧.  
	发送方在发送时会启动一个计时器, 计时结束未收到确认帧会进行自动重传.  
	计时时间应长于往返时延, 发送完帧应该保留副本, 数据帧与确认帧应带有相应编号.  

- ACK 丢失:  
	确认帧丢失时, 发送方的计时器也会超时, 进行重传.  
	接收方收到后, 会丢弃重复帧, 重发确认帧.  

- ACK 迟到:  
	确认帧迟到时, 发送方会进行重传, 接收方会丢弃重复帧, 重发确认帧.  
	发送方收到迟到的确认帧会将其丢弃, 继续后续发送.  


停等协议虽然简单, 但是信道利用率非常低.  


### 后退N帧协议(GBN)


发送方有 n 个窗口(对应 n 个数据帧), 窗口内的数据帧可以连续发送, 收到接收方的确认帧后, 窗口可以集体后移.  

接收方不需要每个帧都发送一个确认帧, 如果收到了多个连续的帧, 只需要发送最后一个帧的确认帧, 表示这之前的所有帧都已接收.  


- GBN发送方必须响应的三件事:  
	1. 上层的调用:  
		上层需要发送数据时, 发送方先检查发送窗口是否已满.  
		如果未满, 则产生一个帧并发送.  
		如果已满, 则返还数据, 表示窗口已满.(一般将数据缓存)  
	
	2. 收到ACK:  
		GBN协议中, 采用 <span style="color:red">累积确认</span> 的方式, 收到 n 号帧的ACK, 表示它本身及之前的所有帧已接收.  
	
	3. 超时事件:  
		计时器同样用于GBN协议中. 如果超时, 会重新方式已发送但未被确认的帧.  


- GBN接收方要做的事:  
	- 如果正确收到 n 号帧, 并且按序(顺序正确?), 则发送一个 n 号帧的ACK, 并将帧的数据部分交付给上层.  
	- 其余情况都将帧丢弃, 并为最近按序收到的帧发送确认帧. 接收方不会缓存任何失序帧.  


- 滑动窗口的长度:  
	如果用 n 位 bite 储存编号, 窗口大小应为 $[1, 2^n - 1]$, 编号为$[0, 2^n - 2]$.  
	
	当窗口为 $2^n$ 个时, 如果接收方已收到全部帧(下一个为0号帧), 而之前的0号帧的确认帧丢失, 发送方会重传之前的全部帧, 接收方会认为是后续的帧, 导致错误.  
	数据帧丢失也可能出现类似上方的错误.  


- 重点总结:  
	- 累积确认(偶尔捎带确认).  
	- 接收方只按序接收帧(一个接收窗口), 接收到其他帧会丢弃.  
	- 接收到错误帧会重新发送前一个帧的确认帧.  
	- 发送窗口数量最大为 $2^n - 1$, 接收窗口大小为 1.  


接收方会丢弃正常传输的后续帧, 而发送方需要全部重传. 这明显降低了效率.  
所以就有了选择重传协议.  


### 选择重传协议(SR)


接收方与发送方一样, 也有 n 个滑动窗口由于接收数据帧.  
每个帧的确认帧都是独立的, 即 <span style="color:red">不采用累积确认</span>的方式.  

- 发送方:  
	收到确认帧, 将对应序号的窗口标识为 **已接收**, 如果此窗口为末尾的窗口, 则末尾窗口(集体)前移至 **未确认/发送** 的窗口处.  
	每个帧都有自己的计时器, 如果超时, 仅重传各自的数据帧.  

- 接收方:  
	接收到在窗口内的帧, 将其标为 **已收到**, 并发送确认帧. 如果其为末尾, 则窗口集体前移至未收到的帧. 并将帧按序交付上层.  
	收到窗口外(小于下界)的帧, 返回ACK, 其他则忽略.  

- 窗口长度:  
	$W_{Tmax} = W_{Rmax} = 2^{n-1}$, 极限情况为发送方全部发送, 接收方全部接收, 但第一个确认帧丢失, 重新发送 1号(0号)帧.  
	所以接收方的最前端不应该与发送方的末端相同.  

- 重点总结:  
	- 对数据帧逐一确认, 收一个确认一个.  
	- 只重传出错帧.  
	- 接收方可以缓存失序的帧(即不会丢弃).  
	- 窗口: $W_{Tmax} = W_{Rmax} = 2^{n-1}$.  



## 介质访问控制☆


- 传输数据使用的两种链路:  
	- 点对点链路: 常用于 广域网.  
	- 广播式链路: 常用于 局域网.  

- 介质访问控制:  
	在<span style="color:red">广播信道</span>中, 为了使众多用户能够合理而方便地共享通信媒体资源, 需要有介质访问控制. 其分为静态划分信道与动态分配信道.  
	- 静态划分: 如信道复用技术, 代价较高, 不适合局域网使用.  
	- 动态分配: 轮询访问介质访问控制, 随机访问介质访问控制.  


介质访问控制:  
![](https://pic.imgdb.cn/item/6520071dc458853aefcecc2d.png)


### 静态划分信道


- 多路复用技术:  
	把多个信号组合在一条物理信道上进行传输.  

信道复用技术:  
![](https://pic.imgdb.cn/item/6520074bc458853aefcee99c.png)


- 多路复用:  
	- 频分多路复用(FDM)  
	- 时分多路复用(TDM)  
	- 波分多路复用(WDM)  
	- 码分多路复用(CDM)  

- 频分多路复用:  
	用户在分配到一定频带后, 在通信过程中一直占用这个频带. 频分复用的所有用户占用着不同的带宽资源.  

- 时分多路复用:  
	将时间划分为等长的时分复用帧(TDM帧).  
	每一个时分复用的用户在每一个TDM帧中占用**固定序号的时隙**(ABCD...), 所有用户轮流占用信道.  

- 统计时分复用:  
	使用一个**集中器**, 对多个用户的数据进行集中, 按顺序发送.  
	每一个STDM帧中的时隙数量小于连接在集中器上的用户数.  
	歌用户有了数据就随时发往集中器的输入缓存, 然后集中器按顺序扫描, 将数据放入STDM帧中, 进行传输.  
	STMD帧不是固定分配时隙, 而是按需动态分配时隙.  

统计时分复用:  
![](https://pic.imgdb.cn/item/652007bbc458853aefcf7383.png)

- 波分多路复用:  
	即 **光的频分多路复用**.  

- 码分多路复用:  


### ALOHA与CDMA


- 随机访问介质访问控制:  
	所有用户可随时发送信息, 发送时占用全部带宽.  
	协议有:  
	- ALOHA协议.  
	- CSMA协议.  
	- CSMA/CD协议.  
	- CSMA/CA协议.  

- ALOHA协议:  
	不监听信道, 随时可以发送.  
	某一个站未发送完时, 另一个站进行发送, 会产生 "冲突".  
	接收方会检测到差错, 不给予确认, 超时后(随机时间)发送方会进行重发.  
	
	时隙ALOHA协议:  
	以时间片为单位划分, 当发生冲突时, 需要等待至下一个时间片开始时进行发送.  
	**时隙机制可以减小发生冲突的概率**.  


- CSMA协议:  
	载波监听多路访问协议.  
	CS(载波监听): 每一个站在发送数据前要检测总线上是否有其他计算机在发送数据.  
	MA(多点接入): 计算机以多点接入的方式接在一根总线上.  
	
	根据监听的结果采取不同的策略可以分为不同的协议.  

因为电磁波传播速率也是有限的, 端与端之间的物理距离导致即使进行监听也可能产生冲突.  

- 1-坚持CSMA:  
	主机发送信息时, 先监  听信道.  
	空闲则直接传输, 不必等待.  
	忙则一直监听, 直到空闲马上传输.  
	如果冲突(未得到回复), 等待随机长的时间在进行发送.  

- 非坚持CSMA:  
	监听时, 信道空闲则直接传输, 不必等待.  
	忙则等待一个随机的时间之后再进行监听.  

- p-坚持CSMA:  
	监听信道时, 空闲则以概率 p 直接传输, 不等待; 概率 1-p 等待到下一个时间片再传输.  
	忙则持续监听直到信道空闲再以概率发送.  
	冲突时等待到下一个时间片进行以上程序进行发送.  

特点总结:  

|   CSMA   |  1-坚持  | 非坚持                 | p-坚持                                 |
|:--------:|:--------:|:---------------------- |:-------------------------------------- |
| 信道空闲 |  马上发  | 马上发                 | p概率马上发</br> 1-p概率下一个时间片发 |
| 信道忙碌 | 持续监听 | 等待随机时间后再次监听 | 持续监听, 直到空闲以概率p发送          |


### CSMA/CD协议★

CS: 载波监听.  
MA: 多点接入.  
CD: 碰撞检测.  

- 碰撞检测(冲突检测):  
	**边发送边监听**, 适配器边发送数据边检测信道上信号电压的变化情况, 以便判断自己在发送数据时其他站是否也在发送数据.  

- 传播时延下的冲突:  
	设两端间的传播时延为 $\tau$.  
	当发生冲突时, 可以根据自己发送时的时间, 和接收到信息的时间, 来判断何时发生了冲突. 设两个时间差为:  
	$接收时时刻 - 发送时时刻 = \delta$, $0 \lt \delta \lt 2 \tau$.  
	
	重传时间(截断二进制指数规避算法):  
	1. 基本退避(推迟)时间为 $2\tau$.  
	2. 设置一个参数 k, 其等于重传次数, 但不超过10, 即 $k = min[重传次数, 10]$.  
	3. 从整数集 $\lbrace{ 0, 1, \dots, 2^k -1 \rbrace}$ 中随机取一个数 r, 重传退避时间 = r * 基本退避时间 = $2r\tau$.  
	4. 当重传达 **16次** 仍未成功, 说明网络过于拥挤, 则抛弃此帧并向上层报告出错.  

- 最小帧长:  
	规定帧的传输时延应大于往返的传播时延.  
	$\frac{帧长(bit)}{数据传输速率} \geq 2\tau$, 即 $最小帧长 = 2 \tau * 数据传输速率$.  

### CSMA/CA协议

CA: 碰撞避免.  

在无线局域网中, 硬件设施难以做到 $360^。$全面检测碰撞, 所以不采用CD.  

- 原理:  
	在发送数据前检测信道是否空闲.  
	空闲则发出 **RTS**, RTS包括发射端的地址, 接收端地址, 持续发送的时间等信息; 忙则等待.  
	接收端收到 RTS 后, 将响应 CTS.  
	发送端收到CTS后, 开始发送数据帧.  
	接收端收到数据帧后, 用CRC校验数据, 正确则响应ACK帧.  


### 轮询访问

- 轮询协议:  
	主节点轮流 "邀请" 从属节点发送数据.  
	可以占用全部带宽, 且不产生冲突.  
	但也有缺点: 1.轮询开销; 2.等待延迟; 3.单点故障;


- 令牌传递协议☆:  
	令牌: 一个特殊格式的MAC控制帧, 不包含任何信息. 用来控制信道的使用, 确保同一时刻只有一个节点独占信道.  
	
	其主要应用于令牌环网(物理星形拓扑, 逻辑环形拓扑).  
	采用的网络通常**负载较重**, **通信量较大**.  
	
	空闲时, 令牌会在各主机间传递.  
	发送时, 会修改令牌标志位(表示信道忙/正在发送数据), 在令牌帧后加上数据, 进行发送.  
	非接收方收到后会传递给下一位, 接收方收到后复制数据, 并继续传递.  
	发送方最后收回发送的数据, 检查无误后, 调回令牌的标志位, 进行传递.  
	
	令牌的持有时间有限制(不能一直发送数据).  


## 局域网☆


局域网(LAN), 指在某一区域内由多台计算机互联组成的计算机组, 使用<span style="color:red">广播信道</span>.  

- 特点:  
	1. 覆盖的范围较小, 如一座或集中的建筑群内.  
	2. 使用专门铺设的传输介质(双绞线, 同轴电缆)进行联网, 数据传输速率较高(10Mb/s - 10Gb/s).  
	3. 通信延迟时间较短, 误码率较低, 可靠性较高.  
	4. 各站为平等关系, 共享传输信道.  
	5. 多采用分布式控制和广播式通信, 能进行广播和组播.  

决定局域网的主要要素为: **网络拓扑**, **传输介质**, **介质访问控制方法**.  

### 要素构成

局域网拓扑结构:  
![局域网拓扑结构](https://pic.imgdb.cn/item/65200ae9c458853aefd0cee3.png)

综合来看, 总线型结构为最优选择.  


- 局域网传输介质:  
	- 有线局域网: 双绞线, 同轴电缆, 光纤.  
	- 无线局域网: 电磁波.  


- 介质访问控制方法:  
	- CSMA/CD: 常用于**总线型局域网**, 也用于树型网络.  
	- 令牌总线: 常用于**总线型局域网**, 也用于树型网络.  
	- 令牌环: 用于环形局域网.  


### 局域网分类


- <span style="color:orange">以太网</span>:  
	以太网是应用最为广泛的局域网, 包括标准以太网(10Mbps), 快速以太网(100Mbps), 千兆以太网(1000Mbps)和10G以太网.  
	它们都符合IEEE802.3系列标准规范. 逻辑拓扑总线型, 物理拓扑为星型或拓展星型. 使用CSMA/CD.  

- 令牌环网:  
	物理上采用了星型拓扑结构, 逻辑上为环形结构. 逐渐淘汰中.  

- FDDI网:  
	物理: 双环拓扑结构; 逻辑: 环形拓扑结构.  

- ATM网:  
	较新型的单元交换技术, 使用53字节固定长度的单元进行交换.  

- <span style="color:orange">无线局域网</span>:  
	采用IEEE802.11标准. WIFI即无线局域网的一种应用.  


### IEEE标准


IEEE802系列标准是IEEE802 LAN/MAN标准委员会制定的局域网, 城域网技术标准(1980.2成立).  
其中最广泛使用的有以太网, 令牌环, 无线局域网等.  
这一系列标准中的每一个子标准都由委员会中的一个专门工作组负责.  

- IEEE标准:  
	802.3: 以太网.  
	802.5: 令牌环网.  
	802.8: 光纤.  
	802.11: 无线局域网.  

IEEE802标准所描述的局域网参考模型只对应OSI参考模型的<span style="color:red">数据链路层与物理层</span>, 它将数据链路层划分为 逻辑链路层LLC子层 和 介质访问控制MAC子层.  

- LLC子层:  
	负责识别网络层协议, 对它们进行封装. 对接收的帧如何处理. 为网络层提供服务.  

- MAC子层:  
	主要功能包括数据帧的封装/卸装, 帧的寻址和识别, 帧的接收和发送, 链路的管理, 帧的差错控制等.  
	MAC子层的存在屏蔽了不同网络层链路种类的差异性.  



### 以太网


以太网(Ethernet)指的是由Xerox公司创建并由Xerox, Intel和DEC公司联合开发的 **基带总线局域网规范**. 为当今现有局域网采用的最通用的通信协议标准.  

以太网使用**CSMA/CD**技术, 使用**曼彻斯特编码**的信号.  

以太网在局域网各种技术中占 **统治性地位**:  
1. 造价低廉, 且简单.  
2. 是应用最广泛的局域网技术.  
3. **满足网络速率要求: 10Mbps ~ 10Gbps**.  


- 以太网两个标准:  
	- DIX Ethernet V2: 第一个局域网产品(以太网)规约.  
	- IEEE 802.3: ...  


以太网提供无连接, 不可靠的服务:  
- 无连接: 发送方和接收方之间无 "握手过程".  
- 不可靠: 不对发送方的数据帧编号, 接收方不向发送方进行确认, 差错帧直接丢弃, 差错纠正由高层负责.  

发展:  
- 传输介质: 粗同轴电缆 -> 细同轴电缆 -> 双绞线+集线器.  
- 物理拓扑: 总线型 -> 星型. 逻辑上仍为总线型.  

10BASE-T以太网站之间的距离不超过100m, 但可以使用集线器扩展范围, 性价比极高, 其为局域网发展史上的里程碑, 从此以太网的拓扑从总线转变为更方便的星形网络.  
> 集线器工作于物理层, 可以视为多接口的中继器.  


#### 10BASE-T以太网


10BASE-T 是传送基带信号的双绞线以太网, T表示采用双绞线, 现10BASE-T采用的是无屏蔽双绞线(UTP), 传输速率为 10Mb/s.  

- 适配器与MAC地址:  
	- 计算机与外界有局域网的连接是通过通信适配器的, 即网卡(网络接口卡NIC), 现在一般直接嵌入主板, 不再单独使用.  
	- 适配器上装有处理器和存储器, 会储存计算机硬件/物理地址(MAC地址).  
	- MAC地址: 每个适配器有个全球唯一的48位二进制地址, 前24位代表厂家(由IEEE规定), 后24位厂家自己指定. 常用6个十六进制数表示.  

- 以太网MAC帧:  
	最常用的MAC帧为以太网V2的格式.  
	为了使发送与接收同步, MAC帧在物理层会在前面插入前导码.  
	由于以太网使用曼彻斯特编码(电压的上下跳动表示01), 无电压变化即视为传输结束(两帧间有一定空白时间).  

![](https://pic.imgdb.cn/item/652007fdc458853aefcfa3a3.png)

- 交换机:  
	使用集线器虽然可以扩大以太网的地理覆盖范围, 但也扩大了碰撞域(冲突域), 即使用CSMA/CD协议产生冲突的概率增加. 多个网络的数据率也需要相同.  
	所以扩展以太网上升至链路层, 使用**网桥**. 后来改为**交换机**(多端口的网桥).  
	交换机每个端口与一个主机或交换机相连, 工作在**全双工方式**, 因此无需使用CSMA/CD协议.  
	其通过构建并维护内部的**交换表**来确定主机与端口的对应关系.  

- 交换表的维护:  
	对交换表的维护依赖交换机的 **"自学习功能"**.  
	当有主机(A)通过端口发送信息时, 交换机会将帧中的 **源地址(MAC)** 与对应 **端口** 进行记录.  
	如果交换表中没有记录目的地址对应的端口号, 则对发送端口外的所有端口进行广播, 对应主机会进行接收.  
	此后, 有发往A的帧都会直接发送到对应端口, 不用进行广播.  
	主机与端口对应关系并不固定, 需要额外记录一个时刻, 将超过时间的记录删除. 每次主机发送信息时, 会更新时刻或是加入.  

当交换机之间进行相连时, 一个交换机上的主机对另外的交换机上的主机进行通信, 由于交换表不会记录非端口连接的主机, 所以必定会进行广播.  
**一个以太网就是一个广播域**, 为了避免循环广播, 交换机之间的连接不应有环, 所以有生成树协议, 形成**无环的树状结构**.  


### 无线局域网(WLAN)


IEEE 802.11系列 是无线局域网通用的标准, 它是由IEEE所定义的无线网络通信的标准.  


- 802.11 的MAC **帧头**(RTS帧)的格式:  
| 帧控制 | 生存周期ID | 地址1 | 地址2 | 地址3 | 序列控制 | 地址4 |  
> 地址为6字节, 其他为2字节.  
> 地址依次为: 接收端(RA), 发送端(TA), 目的地址(DA), 源地址(SA).  

- 无线局域网的分类:  
	- 有基础设施的:  
		无线局域网的中心点叫做**接入点(AP)/无线接入点(WAP)**.  
		**所有在无线局域网中的站点, 对网内或网外的通信, 都需要通过接入点**.  
		现在的接入点AP都有连接到有线以太网的端口.  
	- 无基础设施的:  
		又称 **自组网络**, 没有接入点AP, 由一些处于平等状态的移动站相互通信组成的临时网络.  
		自组网络一般也不和外界的其他网络相连接.  


设备 <-> WIFI连接 <-> 接入点AP <-> (交换机) <-> 路由器 <-> 互联网  


### 虚拟局域网


一般交换机以太网的缺点:  
1. 一个以太网为一个广播域, 不同交换机上的主机通信经常产生大量的广播帧.  
2. 广播造成的信息安全, 泄漏问题.  

虚拟局域网(VLAN), **将局域网内的设备划分成与物理位置无关的逻辑组**. 这些逻辑组有某些共同的需求, 每个VLAN是一个单独的广播域, 即为不同的子网.  

可以通过交换机的接口, 或者MAC地址进行划分(标识)为不同的VLAN.  

以太网的MAC帧进行拓展, 称为 802.1Q帧:  
| 目的地址(6) | 源地址(6) | **VLAN标记**(4) | 类型(2) | 数据(42～1500) | FCS(4) |  
> VLAN标记前两字节为固定的IEEE802.1Q标签类型, 后两字节有效位只有后12位, 标识其属于哪个VLAN.  

802.1Q帧 只在交换机之间通信时出现.  
不同VLAN之间的通信需要 路由器 或者 实现第三层的转发功能的交换机.  


## PPP协议


PPP(点对点)协议为**广域网**中使用的**链路层协议**. 其**只支持全双工链路**.  

局域网使用广播信道, 所以不会采用点对点信道的PPP协议.  


- PPP协议的要求:  
	- 简单.  
	- 封装成帧.  
	- 透明传输.  
	- 多种网络层协议.  
	- 多种类型链路.  
	- 差错检测(CRC).  
	- 检测链路状态.  
	- 最大传输单元.  
	- 网络层地址协商: 使网络层实体能知道彼此的网络层地址.  
	- 数据压缩协商.  


- PPP协议三个组成部分:  
	- 一个将IP数据报封装到串行链路的方法.  
	- 链路控制协议(LCP): 建立, 配置, 测试数据链路连接.  
	- 网络控制协议(NCP): 每一个NCP支持不同的网络层协议.  

- PPP协议的帧格式:  
![PPP协议帧格式](https://pic.imgdb.cn/item/656935fcc458853aef8e3387.png)  

- HDLC协议:  
	高级数据链路控制, 早期的链路层协议.  
	现在已经很少使用.  


# 网络层


**为什么需要网络层**:  
不同的局域网其采用的协议很可能不同, 这是由其本身的需求决定的, 采用同一种协议无法满足各种不同的需求.  
如何将不同的局域网相连, 既然不能采用同一种协议, 就只能在往上层统一格式.  
即不同局域网传输的数据部分需要格式统一(IP数据报), 由路由器将接收的帧进行拆解, 取得数据报, 再根据发送的接口的协议重新封装.  
这样数据可以在不同的局域网之间传递, 如无线局域网到以太网.  


网络层的设计思路:  
网络层要设计得尽量简单, 向上提供简单灵活的, 无连接的, 尽最大努力交付的数据报服务.  
**网络层不提供服务质量的承诺**.  **无连接的, 不可靠的数据报服务**.


不同网络中的主机间通信需要经过若干个路由器转发分组来完成.  
> 分组: 早期的定义容易相互混淆. 分组与**数据报**同义. 也称IP分组, IP数据报.  

路由器之间传送的信息有两大类:  
- 转发源主机之间所传送的数据.  
- 传送路由信息: 创建路由表, 由此导出转发表, 为传送数据服务.  


## SDN

随便看看...

- 网络层两个层面:  
	网络层可以抽象地划分为两个层面(plane): 数据(转发)层面, 控制层面.  
	层面为抽象的概念, 与层次类似, 也可译为平面.  
	数据层面即转发分组, 控制层面需要共同协作创建各自的路由表.  
	控制层面(s)比数据层面(ns)要慢上许多.  

- 传统控制层面:  
	**路由选择算法运行在每台路由器中**, 每台路由器都有转发和路由选择两种功能.  

- SDN方法:  
	SDN, 软件定义网络.  
	路由器中不再需要路由选择软件, 路由器间也不用交换路由信息.  
	取而代之的是**远程控制器**(物理上可以由多个服务器组成), 其掌握各主机和整个网络的状态, 为每个分组计算出最佳路径, 然后在每个路由器中生成其正确的转发表.  


SDN方法使网络又变成集中控制. 但并非整个互联网都变成集中控制模式, 这并不现实.  
在一些条件下, 如大型的专用数据中心之间的广域网, 其效果比较好.  








## 网际协议 IP


网际协议 IP(Internet Protocol), 是 TCP/IP 体系中两个最主要的协议之一.  
目前使用的为第四个版本, 记为 IPv4. 其也正在向 IPv6 过渡.  

与 IP 配套使用的还有三个协议:  
- 地址解析协议 ARP(Address Resolution Protocol).  
- 网际控制报文协议 ICMP(Internet Control Message Protocol).  
- 网际组管理协议 IGMP(Internet Group Management Protocol).  


转发:  

分组在节点(路由器与主机)间转发,  
如果需要经过其他路由器(在不同网络中), 则称为间接交付;  
如果不需要经过路由器(在同一网络内), 称为直接交付.  

分组每次转发都称为一 "**跳(hop)**", 也译为**跃点**. 转发分组时也常使用"下一跳(next hop)"的说法.  


### IP地址

整个互联网为**单一的, 抽象的网络**.  
IP地址就是给每个连接到互联网上的设备(主机或路由器)的一个接口.  
其为全球唯一的32位的标识符. 由ICANN进行分配.  
**每 8 位组成一个 十进制数(0-255), 方便记忆**.  

IP地址由两个字段组成:  
| 网络号 | 主机号 |

具有相同网络号的主机表示其在同一个网络内.  
划分出网络就可以更方便进行路由选择, 毕竟网络的数量远小于主机的数量.  

### IP地址的分类

IP地址一共32位, 当网络号为 n 位时, 主机号就为 32-n 位. (2^32约等于43亿).  
根据网络号的长度(n = 8, 16, 24), 分为 A, B, C类网络, 其都为**单播地址**(一对一通信), 最常用.
D类为多播地址, E类为保留地址.  
通过IP地址的前几个bite位(或第一个16进制数)可以识别其网络类别.  

- IP地址分类:  
![IP地址分类](https://pic.imgdb.cn/item/65693730c458853aef91459a.png)

有一些特殊的IP地址一般不会指派, 只在特定的时候使用.  

| 网络号 |     主机号      | 源地址使用 | 目的地址使用 |        代表的意思         |
|:------:|:---------------:|:----------:|:------------:|:-------------------------:|
|   0    |        0        |    可以    |     不可     |    在本网络上的本主机     |
|   0    |        X        |    可以    |     不可     | 在本网络上主机号为X的主机 |
|  全1   |       全1       |    不可    |     可以     |   只在本网络上进行广播    |
|   Y    |       全1       |    不可    |     可以     |  在网络号为Y的网络上广播  |
|  127   | 非全0/1的其他数 |    可以    |     可以     |   用于本地软件环回测试    | 


由于近年来无分类地址的广泛使用, ABC类这种分类地址已成为历史.  
因为其每个网络中的主机数量是固定的, 且数量差距巨大.  
为了更加灵活地使用IP地址, 出现了划分子网的方法, 在主机号中再次划分出 "子网号", 使其成为三级地址.  
后又出现无分类编址方法, 目前广泛使用~~(正被淘汰)~~.  


### 无分类编址 CIDR

全名为**无分类域间路由选择** CIDR(Classless Inter-Domain Routing).  

- 网络前缀:  
	将"网络号"改为"(网络)前缀", 区别为 前缀的位数可以为$0 \sim 32$ 的任意值. 剩下的仍为主机号, 也可以称为后缀.  
	CIDR 使用 "斜线记法", 在IP地址后加斜线"/", 再跟前缀的位数.  

- 地址块:  
	CIDR 将网络前缀都相同的所有连续IP地址组成一个"CIDR地址块", 其包含的IP地址数目取决于前缀的位数.  
	一个地址块代表的是一个网络.  

- 地址掩码:  
	使用斜线记法可以知道网络前缀的位数, 但为了方便计算机计算, 一般使用32位的 "**子网掩码**", 简称 掩码.  
	其前部分有多少个 1, 就代表地址前缀有多少位, 即斜线后的数字为掩码中 1 的个数.  
	将 IP地址 与 掩码 进行按位与运算就可以得出其网络前缀.  
	
	如 A类地址的子网掩码: /8  
	11111111.00000000.00000000.00000000  
	255.0.0.0


在CIDR中, 前缀的位数必须给出, 无法仅通过一个32位地址来确定其所在网络和地址.  
在地址分配时, 可以先分配一个短的网络前缀, 机构可以增长网络前缀来继续划分子网.


### ARP协议

在传输过程中, 知道一个机器(主机或路由器)的IP地址, 但还需要找出对应的MAC地址, 才能在链路层进行传输.  
地址解析协议 ARP, 就是从IP地址到MAC地址的转换.  

ARP协议会在主机的ARP高速缓存中存放一个**从IP地址到MAC地址的映射表**.  
表中存储本局域网上的各主机和路由器的IP地址与对应MAC地址, 并动态更新.  
当主机A要向**本局域网**的某主机B发送数据时, 其会先在表中查找B的IP地址, 找到时, 即有对应的MAC地址; 没有时, 运行ARP:  
1. 在本地局域网广播一个ARP请求分组, 携带的信息有本机的IP与MAC地址, B主机的IP地址.  
2. 本局域网上所有主机的ARP进程都会收到此请求分组.  
3. IP与请求中一致的主机(B)会向A发送响应分组(单播), 在其中写入自己的MAC地址. 也会记录A的IP与MAC地址.  
4. 主机A会收到并记录.  

表中的记录是有生存时间的, 会将过期的记录删除.  
ARP只用于解决<span style="color:red">同一局域网中</span>的IP/MAC地址转换!  


### IP数据报

IP数据报格式:  
![IP数据报格式](https://pic.imgdb.cn/item/6569388fc458853aef950e5f.pnga)

- 版本:  
	占4位, 指协议IP的版本. IPv4.  
- 首部长度:  
	占4位, 最大值为15, 单位为32位字长(8字节). IP数据报固定部分为20B, 所以其数值从 5(0101) 开始.  
	当首部长度不是4字节的整数倍时, 会在"填充"部分填充.  
- 区分服务:  
	占8位, 用来获得更好的服务. 实际上一直没有被使用过.  
- 总长度:  
	占16位, 整个IP数据报的长度. 其值在 20 ～ 65535. 单位: 字节.  
	一般IP数据报不会那么长.  
- 标识, 标志, 片偏移:  
	见 [IP数据报的分片](#IP数据报的分片)  
- 生存时间:  
	占8位, TTL. 每经过一个路由器, 其值减一. 为零时丢弃此数据报.  
- 协议:  
	占8位, 指出数据部分使用的协议类型. 不同值代表不同协议.  
	如:ICMP(1), IGMP(2), TCP(6), EGP(8), IGP(9), UDP(17), IPv6(41)...  
- 首部检验和:  
	占16位, 只检验数据报的首部, 不包括数据部分.  
	同样为了减小计算量, 采用求和为0的方式.  
- 源地址, 目的地址:  
	各占32位, 为发送, 接收方主机的IP地址.  

- 可变部分:  
	用来支持 排错, 测量以及安全等措施. 但很少使用.  
	其长度从 1-40字节不等. 
- 填充:  
	使用全 0 的填充字段使首部长度为4字节的整数倍.  


### IP数据报的分片


- 最大传输单元 MTU:  
	数据链路层有规定**数据帧的数据部分**最大长度, 即MTU. 例如, 以太网规定MTU值为1500字节.  
	当IP数据报长度超过MTU, 就需要进行分片处理, 即分为多个数据报.  
	每个分片也都会有自己的首部

IP数据报首部中对分片的处理:  

- 标识:  
	占 16 位. 同一数据报的分片使用相同的标识.  
- 标志:  
	占 3 位, 目前只有两位有意义.  
	- 最低位 MF(More Fragment). MF = 1, 即后面还有分片; MF = 0, 为最后一个分片.  
	- 中间位 DF(Don't Fragment). DF = 0, 允许分片; DF = 1, 不允许分片.  
	只有当 DF = 0 时, MF才有意义.  
- 片偏移:  
	占 13 位, 表示此分片在原数据报中的相对位置.  
	以8字节为单位, 由此, 除最后的一个外, 其余分片长度都是8字节的整数倍.    


### DHCP协议


主机获得IP地址的方式有两种:  
- 静态配置:  
	给主机配置固定的 IP地址, 子网掩码, 默认网关.  
- 动态配置:  
	由 DHCP服务器 动态地给主机分配IP地址.  

DHCP:  

为<span style="color:red">应用层</span>协议, 使用 <span style="color:red">客户/服务器</span> 方式, 客户端和服务器通过<span style="color:red">广播</span>方式进行交互, 基于 <span style="color:red">UDP</span>.  
其提供**即插即用**联网的机制, 主机可以从服务器动态地获得IP地址等.  

过程:  
1. 主机广播 DHCP "发现报文".  
	主机试图寻找DHCP服务器.  
2. DHCP服务器广播 DHCP "提供报文".  
	服务器拟分配主机一个IP地址, 可能有多个DHCP服务器发送.  
3. 主机广播 DHCP "请求报文".  
	回复服务器, 确认使用IP地址. 其他服务器发送的多余的IP就不会被分配.  
4. DHCP服务器广播 DHCP "确认报文".  
	回复主机, 确认IP被使用.  

### 网际控制报文协议ICMP


ICMP主要支持主机或路由器进行**差错或异常报告**和**网络探寻**.  

ICMP报文:  
虽然ICMP报文装在IP数据报的数据部分,但它是网络层的协议.  
结构:  
![ICMP报文](https://pic.imgdb.cn/item/65693a5ac458853aef9982f9.png)  

ICMP报文的类型:  
<table style="text-align:center;" border="1px solid black" cellspacing="0">
	<tr>
		<th>ICMP报文种类</th>
		<th>类型的值</th>
		<th>ICMP报文的类型</th>
	</tr>
	<tr>
		<td rowspan="4">差错报告报文</td>
		<td>3</td>
		<td>终点不可达</td>
	</tr>
	<tr>
		<td>11</td>
		<td>时间超过</td>
	</tr>
	<tr>
		<td>12</td>
		<td>参数问题</td>
	</tr>
	<tr>
		<td>5</td>
		<td>改变路由</td>
	</tr>
	<tr>
		<td rowspan="2">询问报文</td>
		<td>8或0</td>
		<td>回送(Echo)请求或回送回答</td>
	</tr>
	<tr>
		<td>13或14</td>
		<td>时间戳(Timestamp)请求或时间戳回答</td>
</table>

**差错报文**:  
1. 终点不可达:  
	当路由器或主机不能交付数据报时就向源点发送终点不可达报文.  
2. 时间超过:  
	当路由器收到生存时间为零的数据报时, 除了丢弃外, 还要向源点发送时间超过报文.  
3. 参数问题:  
	当路由器或目的主机收到的数据报的首部中有字段的值不正确时, 就丢弃并向源点发送参数问题报文.  
4. 改变路由(重定向):  
	路由器把改变路由报文发送给主机, 让主机知道下次应将数据报发送给另外的路由器(有更好的路由).  

不应该发送差错报告的情况:  
- 对于ICMP差错报告报文, 不需要再发送差错报告. 即报告出错, 不用再报告.  
- 对第一个分片的数据报片之后所有的数据报分片, 都不再发送差错报告.  
- 对具有多播地址的数据报, 不发送差错报告.  
- 对具有特殊地址(如127.0.0.1或0.0.0.0)的数据报, 不发送差错报告.  

**询问报文**:  
1. **回送请求**和**回送回答**报文:  
	主机或路由器向一个特定的目的地发出询问, 收到的主机需要发送回送回答报文.  
	用来测试目的站**是否可达**以及了解其**有关状态**.  
2. **时间戳请求**或**时间戳回答**报文:  
	利用报文中记录的时间戳(发送时间和接收时间), 计算往返时延.  


**应用**:  

1. PING:  
	测试两个主机之间的连通性, 使用ICMP回送请求和回答报文.  
2. Traceroute:  
	用来跟踪一个分组从源点到终点的路径.  
	只要从源主机发送一连串生存时间不断增加(1-n)的IP数据报, 且封装无法交付的数据.  
	在其TTL为0时, 返回超时的差错报告, 到达主机时返回终点不可达差错报告.  


### IPv6


为了解决IPv4的地址耗尽问题, 开始部署IPv6.  
IPv6将地址空间从32位增大到128位.  

- IPv6首部:  
![IPv6数据报格式](https://pic.imgdb.cn/item/65693ab2c458853aef9a6803.png)  
> IPv6数据报由两部分组成(基本首部, 有效载荷).  
> 首部长度固定为40字节, 扩展首部放入载荷部分.  

![IPv6首部](https://pic.imgdb.cn/item/65693b7bc458853aef9c52d2.png)  

- 版本:  
	占 4 位. 指协议的版本, 6.  
- 优先级(通信量类):  
	占 8 位. 区分不同优先级的数据报. 与'区分服务'的作用类似.  
- 流标签(标号):  
	占 20 位. '流'指从特定源点到特定终点(单播或多播)的一系列数据报. 属于同一个流的数据报拥有相同的流标签.  
- 有效载荷长度:  
	占 16 位. 指除基本首部以外的字节长度. 最大 16K.  
- 下一个首部:  
	占 8 位. 当没有扩展首部时, 指出数据部分的协议类型(如 6--TCP, 17--UDP); 当有扩展首部时, 指出后一个扩展首部的类型.  
- 跳数限制:  
	占 8 位. 即 生存时间.


IPv6做出的更改:  
- 地址空间增加.  
- 移除校验和字段, 加快处理时间.  
- 可选字段改为扩展首部.  
- 支持**即插即用**, 即自动配置, 无需DHCP协议.  
- 首部为 8B 的整数倍, IPv4为 4B 的整数倍.  
- IPv6 只能在主机处分片.


**IPv6的地址**:  

128位的地址每16位为一组用16进制数表示, 中间用冒号分隔 ':'.  
$$68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF$$
数字前面的'0'可以省略, 连续的多个 0也可以省略, 如:  
$$FF05:0:0:0:0:0:0:B3$$
$$FF05::B3$$
当然, 每个地址只能有一次这样的压缩, 不然会有歧义.  


**三种基本类型的地址(目的地址)**:  
1. 单播: 点对点通信.  
2. 多播: 一对多通信, 广播为多播的特例.  
3. 任播: 一对一组中的一个, 将数据报交给一组计算机中的一个, 通常为距离最近的一个.  


**从IPv4到IPv6的过渡**:  

由于互联网的超大规模, 向IPv6过渡只能逐步演进, 还需要向后兼容.  

1. 双协议栈:  
	主机或路由器同时装有IPv4和IPv6两种协议栈.  
	安装两套协议付出的代价太大, 所以一般采用隧道技术.  
2. 隧道技术:  
	在IPv6数据报进入IPv4网络时, 将IPv6数据报封装为IPv4数据报.  


## 路由选择协议


- 路由表/转发表:  
	每个路由器都有各自的路由表.  
	从网络的一点到另一点有许多不同的路径, 路由表即指明到指定目的地的下一跳地址.  

路由选择协议的核心是路由算法, 即需要某种算法来获得路由表中的各项目.  

路由算法可以被分为两大类:  
- 静态路由算法:  
	人工配置每一条路由, 采用静态路由选择.  
	只适用于简单的小网络, 无法适应网络的变化.  
- 动态路由算法:  
	能较好地适应网络的变化, 实现复杂, 开销大.  


分层次的路由选择协议:  
由于互联网的规模非常大, 而且一些单位保密的需要, 互联网采用分层次的路由选择协议.  
将整个互联网划分为小的**自治系统(AS)**, 路由选择协议就可以分为两类:  
- 内部网关协议(IGP), 自治系统内部使用的路由选择协议.  
- 外部网关协议(EGP), 不同自治系统之间的路由选择协议.  
外部, 内部也称为 域间, 域内路由选择协议.  


### 内部网关协议RIP


RIP是 IGP 中最先得到广泛使用的协议.  
RIP是一种分布式的**基于距离向量的路由选择协议**, 其最大的优点是简单.  

每个路由器都要维护从它自己到其它网络的距离记录.  
距离通常为"跳数", 每经过一个路由器, 距离加 1, 其直连的网络距离为1.  
距离最大为15, 16表示不可达. 显而易见, <span style="color:red">RIP只适用于小型互联网</span>.  

信息交换规则:  
- 仅和**相邻路由器**交换信息.  
- 交换的信息为当前自己的**路由表**. 
- 按固定的时间间隔交换信息, 30s.  

在一般情况下, 协议RIP可以较快**收敛**, "收敛"即在自治系统中的所有节点都得到正确的路由选择信息的过程.  

路由表:  

| 目的网络 | 距离 | 下一跳 |
| -------- | ---- | ------ |


**距离向量算法**:  

1. 对于地址为 X 的相邻路由器发来的RIP报文, 先修改其所有项目的"下一跳"字段为 X. 并将所有"距离"字段加 1.  
2. 对于每一项:  
	- 如果路由表中没有"目的网络" -- Net, 就把该项加入到路由表中.  
	- 如果有, 并且下一跳为 X, 则进行替换; 不是 X, 距离更小则替换, 否则不处理.  
3. 如果 180s 还没有收到相邻路由器的报文, 则将其距离置为16(不可达).  


RIP协议的报文格式\*:  
![RIP报文格式](https://pic.imgdb.cn/item/65693bebc458853aef9d4cff.png)

**RIP的坏消息传得慢**:  
当网络出现故障时, 要经过较长的时间才能将此信息传送到所有的路由器.  
> 路由器R1到Net1的链路出现故障, 将到其的距离改为16, 但需要经过30秒才能传播出去.  
> 在此之前, 如果另一个路由器R2传来信息"Net1, 2, R1". 误以为可以通过R2到达Net1. 更新自身路由表 "Net1, 3, R2", 再将其法给R2...  
> R2 也会更新自己并接着传给 R1, 直到距离为 16...  


**总结**:  
RIP 的优点是 **实现简单, 开销小**.  
缺点: 规模无法扩大, 规模越大开销越大, 坏消息传得慢.  


### 内部网关协议OSPF


OSPF(Open Shortest Path First), 开放最短路径优先.  
最短路径优先: 使用了 Dijkstra 的最短路径算法 SPF.  

OSPF最主要的特征为使用 **链路状态协议**.  
- 向本自治系统中**所有路由器**发送信息(洪泛法).  
- 交换的信息为: 与本路由器相邻的所有路由器的链路状态.  
	链路状态: 链路的两端以及"度量"/代价(即为距离,费用,时延等).  
- 当链路状态变化或相隔一定时间(如30min), 使用洪泛法发送信息.  

所有路由器到最后都能建立一个**链路状态数据库**, 也是一个全网的拓扑结构图.  
每个路由器都能通过SPF算法得到到其它节点的最短路径.  

为了使OSPF能够用于大规模的网络, 会将自治系统再划分为若干的小**区域**(<=200个路由器). 构成双层的OSPF, 上层的为主干区域, 用于连通其他区域. 由**区域边界路由器**相连. 主干中与其他自治系统交换信息的为 **自治系统边界路由器**.  


\*OSPF的五种分组类型:  
1. 问候(hello)分组, 用来发现和维持邻站的可达性.  
2. 数据库描述(DD)分组, 向邻站给出自己的链路状态数据库的摘要信息.  
3. 链路状态请求(LSR)分组, 向对方请求发送某些链路状态项目的详细信息.  
4. 链路状态更新(LSU)分组, 用洪泛法对全网更新链路状态.  
5. 链路状态确认(LSA)分组, 对链路更新分组的确认.  


### 外部网关协议BGP


BGP将全世界数以万计的AS孤岛相连, 在它们之间架起桥梁.  

为什么外部网关不能使用内部网关一样/类似的协议?  
1. 互联网规模巨大, AS的数量过于庞大.  
	几十万的AS使路由选择变得困难, AS之间的路径代价也不好定义.  
2. AS之间的路由选择必须考虑有关策略.  
	路径选择会受到政治, 安全, 经济等因素的考虑.  

BGP只求选出一条比较好的路径, 而非最佳路径.  


**BGP路由**:  

一个自治系统AS中有两种不同功能的路由器, 即**边界路由器(边界网关)** 和 **内部路由器**.  

当两个边界路由器进行通信时, 需要先建立 TCP连接(179端口), 即eBGP连接.  
边界路由器会通过内部的TCP连接(iBGP)将信息传送给内部路由器, 因为信息的传递可能需要穿过自治系统内部.  

**边界路由器之间会相互通信, 并将信息传给内部路由器.**  

[TCP协议](#...)  

- BGP路由格式:  
	BGP路由 = "前缀, BGP属性" = "前缀, AS-PATH, NEXT-HOP".  
	- 前缀: 子网前缀(终点).  
	- AS-PATH: 需要经过的自治系统.  
	- NEXT-HOP: 下一跳.  
	
	下一跳如果在本自治系统内, 会先找对应的边界路由器.  
	之后按内部网关协议到边界路由即可.  

三种不同的自治系统:  
...  

- 路由选择:  
	- 本地偏好.  
	- AS跳数最少.  
	- 热土豆-最快到达边界.  

- BGP四种报文:  
	- OPEN报文: 用来与相邻的BGP对等端建立关系.  
	- UPDATE报文: 用来通告新路径或撤销原路径.  
	- KEEPLIVE报文: 用来周期性地证实与对等端的连通性.  
	- NOTIFICATION报文: 用来发送检测到的差错.  

## IP多播


在一对多的通信中, 多播可以节约大量网络资源.  
一份信息要发送给100人, 那么主机可能需要发送100次, 如果在传输过程中的岔路口能够复制发往不同的方向, 就能一次性发送给多个人.  

能够运行多播协议的路由器称为多播路由器.  
**多播所传送的分组需要使用多播地址.**  
因为不可能在目的地址写下所有需要它的主机地址.  
只能在目的地址写入多播组的标识符, 设法将加入多播组的IP与之关联.  

多播地址即D类地址, 以1110开头.  
一个多播地址即一个多播组.  
多播地址只能作为目的地址, 不能用于源地址.  
多播数据报不产生ICMP差错报文.  


### 局域网的硬件多播


指多播数据报进入局域网时, 如何交付给多播组的成员.  
局域网对于多播数据报(MAC帧)会进行**广播**, 加入的主机会收下.  

局域网内的传输通过MAC帧, 需要MAC地址(48位). 其高24位为: 00-00-5E.  
当MAC地址字段为 01-00-5E 开头即为多播地址. 其前25位为固定不变的部分.    
再将后23位改为多播IP的后23位.  

多播IP有28位可以, 但只有23位进行映射. 那么不同的多播IP可能映射为相同的多播MAC地址, 所以主机还需要在IP层进行过滤.  

总之, 如果MAC帧中的多播IP为自己需要的, 主机会收下.  


### IP多播需要的协议


1. 网际组管理协议(IGMP):  
	让连接在**本地局域网**上的多播路由器知道本局域网上**是否有主机参加或退出了某个多播组**.  
2. 多播路由选择协议:  
	顾名思义, 多播数据报的路由选择.  
	其比单播路由选择协议复杂的多.  
	- 需要动态地适应多播组成员的变化.  
	- 不仅要考虑目的地址(多播地址), 还要考虑其来源和去处.  
	- 多播数据报可以由没有加入多播组的主机发出, 也可以通过没有其组成员的网络.  


**网际组管理协议IGMP**:  
工作过程:  
1. 主机加入时, 该主机应向多播组的多播地址发送一个IGMP报文. 本地的多播路由器收到IGMP报文后, 还要利用多播路由选择协议把这种组成员关系发送给互联网上的其他多播路由器. 
2. 本地多播路由器要周期性地探寻本地局域网上的主机, 以便知道这些主机是否还继续是组的成员. 如果经过几次的探寻后仍没有一台主机响应, 就认为本网络上的主机已经都离开了这个组, 因此也就不再把这个组的成员关系转发给其他的多播路由器. 

**多播路由选择协议**:  

多播路由选择实际上就是要找出以源主机为根节点的**多播转发树**.  
不同的多播组对应于不同的多播转发树. 同一个多播组, 对不同的源点也会有不同的多播转发树.  

转发多播数据报时使用的方法:  
- 洪泛与剪除:  
- 隧道技术:  
- 基于核心的发现技术:  


## 虚拟专用网VPN


由于IP地址的紧缺,一个机构能够申请到的IP地址数量往往小于其拥有的主机数量, 一个机构内也并不需要把所有的主机都接入到外部的互联网. 一些计算机可以使用仅在本地机构有效的IP地址(**本地地址**), 而不需要向互联网的管理机构申请全球唯一的IP地址(**全球地址**). 这样可以节约大量地址资源.  

- 专用地址:  
	这些地址只能用于一个机构的**内部通信**, 而不能用于互联网上的主机通信.  
	在互联网中的所有路由器, 对目的地址是专用地址的数据报一律**不进行转发**.  
	
	- 10.0.0.0/8  
	- 172.16.0.0/12  
	- **192.168.0.0/16**  

采用这样的专用IP地址的互联网络, 称为专用互联网或本地互联网. 或简称专用网.  
一个分布范围很广的大型机构, 可以构建**虚拟专用网**(VPN)来进行交换信息.  


**网络地址转换(NAT)**:  

网络地址转换是本地IP与互联网中的主机通信最常用的方法.  
需要在专用网连接到互联网的路由器上安装NAT软件, 称为NAT路由器. 它至少有一个有效的外部全球IP地址.  
其会将本地地址转换成全球IP地址.  

为了更有效地利用NAT路由器上的全球IP地址, 会将运输层的端口号也利用上.  
每个全球地址的每个端口都可以对应一个本地地址.  
使用端口号的 NAT 也称为 NAPT.  




# 运输层


运输层负责向上面的应用提供通信服务.  
通信的两端应当是两个主机中的应用进程.  
运输层的重要功能就是**复用**和**分用**.  
> 复用: 不同的应用进程都可以使用同一个运输层协议传送数据.  
> 分用: 运输层在剥去报文的首部后可以正确地交付给对应的应用进程.  

运输层会进行差错检测, 协议有 **面向连接的TCP** 和 **无连接的UDP**.  
- UDP(用户数据报协议), 在传送数据之前**不需要先建立连接**. 接收方不需要回复确认.  
- TCP(传输控制协议), 在传送数据前必须先建立连接, 数据传送结束后需要释放连接. TCP不提供广播和多播服务. 为了传输的可靠, 其首部更长, 占用的cup资源更多.  


## 运输层端口


为了完成运输层的复用与分用, 给应用层的每个应用进程赋予一个唯一的标志是非常必要的.  
在计算机中, 进程间的区分取决于进程控制块的进程标识符, 但不同操作系统的标识符格式不同, 需要一个与操作系统无关的统一格式 -- 端口.  

当应用层发送数据时, 应用进程将数据发送到适当的端口; 运输层收到数据时, 将数据发送到适当窗口, 应用进程从该端口读取数据.  

运输层使用 16位的**端口号**来标识一个端口.  
端口号只在本地意义, 不同计算机上的相同端口号没有关联.  
由此, 进程间通信<span style="color:orange">需要知道对方的端口号</span>.  


端口号分类:  
- 服务器端使用的端口号:  
	- 熟知端口号(全球通用端口号), 1 - 1023.  
		它会被指派给TCP/IP一些最重要的应用程序, 让所有用户都知道.  
		就像一些紧急电话一般.  
	- 登记端口号, 1024 - 49151.  
		给没有熟知端口号的应用程序使用, 需要登记防止重复.  

|  应用程序  | FTP | TELNAT | SMTP | DNS | TFTP | HTTP | SNMP | SNMP(trap) | HTTPS |
|:----------:|:---:|:------:|:----:|:---:|:----:|:----:|:----:|:----------:|:-----:|
| 熟知端口号 | 21  |   23   |  25  | 53  |  69  |  80  | 161  |    162     |  443  |

- 客户端使用的端口号:  
	在客户进程运行时动态选择, 也称为**短暂端口号**.  


## UDP协议


UDP只在IP数据报服务上增加了很少的功能: **复用, 分用, 差错检测**.  

- UDP的主要特点:  
	- **无连接**: 可以减小开销和发送数据之前的时延.  
	- **尽最大努力的交付**: 不保证可靠交付.  
	- **面向报文**: 对应用层的报文, 保留报文的边界, 不进行合并或拆分.  
	- **没有拥塞控制**: 实时应用要求主机以恒定速率发送数据, 允许丢失, 不允许较大的时延.  
	- 支持多对多的交互通信.  
	- **首部开销小**: 只有 8 字节.  


<span style="color:blue">首部格式</span>:  

| 源端口 | 目的端口 | 长度 | 检验和 |
| ------ | -------- | ---- | ------ |

- 其每个字段都是 2字节.  
- 源端口: 在需要对方回信时选用, 负责全 0.  
- 目的端口: 在终点交付报文时必须使用.  
- 长度: UDP数据报的长度.  
- 检验和: 校验部分, 有错则丢弃.  

UDP校验时会增加一个 **"伪首部"**, 内容:  

| 源IP地址(4) | 目的IP地址(4) | 0(1) | 17(1) | UDP长度(2) | 
|:-----------:|:-------------:|:----:|:-----:|:----------:|
其仅在校验时存在.  


## TCP协议

### TCP概述


- TCP的特点:  
	- **面向连接**的运输层协议: 在使用TCP之前需要先建立TCP连接.  
	- TCP连接只有两个端点, TCP连接是**点对点**的.  
	- 提供**可靠交付**的服务, 无差错, 不丢失, 不重复, 不乱序.  
	- 提供**全双工通信**.  
	- 面向**字节流**: 虽然应用程序与TCP的交互单位为数据块(大小不等), 但TCP视其为字节流.  


- TCP连接:  
	TCP连接的端点叫 **套接字(socket)**, 端口号拼接到IP地址即构成套接字.  
	socket = (IP地址 : 端口号)  
	TCP连接 ::= {socket1, socket2} = {(IP1:port1), (IP2:port2)}  


### TCP报文段的首部格式

<span style="color:blue">TCP报文段的首部格式</span>:  
![TCP首部格式](../../image/计算机网络/TCP首部格式.png)  

- 源端口与目的端口:  ...  
- 序号:  
	占4字节, TCP连接中传送的字节流中的**每一个字节都按序编号**.  
	序号代表本报文段中**数据第一个字节的编号**.  
- 确认号:  
	占4字节, 代表 **期望收到对方下一个报文段的第一个数据的字节编号**...  
	即接收方应返回的确认号, 如果全部接收成功的话.  
	确认号 = 序号 + 数据长度.  
- 数据偏移:  
	占4位, 指TCP报文段的长度, 单位: 4B. 即最大表示 60字节.  
- 保留:  
	占6位, 保留. 目前置0.  
- 6个控制位:  
	- **紧急URG**:  
		URG = 1时, 表示报文有紧急数据, 无需按序排队, 会插在报文段数据的最前面.  
		与首部中的**紧急指针**字段配合使用.  
	- **确认ACK**:  
		ACK = 1时, 确认号字段有效.  
	- 推送PSH:  
		接收方TCP收到 PSH = 1 的报文段会尽快地交付给应用进程.  
	- 复位RST:  
		RST = 1时, 表明TCP连接中出现严重差错, 需要释放并重建连接.  
	- **同步SYN**:  
		SYN = 1 而 ACK = 0时, 表明这是一个连接请求报文段, 如果同意, 回复SYN = 1, ACK = 1.  
		其他时候为 0.  
	- **终止FIN**:  
		用来释放连接, FIN = 1时, 表明发送完毕, 要求释放连接.  
- 窗口:  
	占2字节, 指自己的**接收窗口**的大小. 即还可以接收的字节数量.  
- 校验和:  
	占2字节, 校验范围包括首部和数据部分, 和UDP一样要加上伪首部.  
	伪首部的第四个字段(17)改为6.  
- 紧急指针:  
	占2字节, 指出紧急数据的字节数, 紧急数据后接普通数据.  
- 选项:  
	最多40字节. 有 **最大报文段长度MSS**, 窗口扩大选项, 时间戳选项等.  
- 填充:  
	使首部为4字节的整数倍.  


### TCP连接管理


TCP连接的建立采用 **客户服务器方式**, 发起方进程称为 **客户**, 等待连接建立的进程称为 **服务器**.  

TCP连接建立的过程叫作 <span style="color:blue">三次握手</span>.  
![TCP连接的建立](../../image/计算机网络/TCP连接的建立.png)  

服务器进程会创建 **传输控制块TCB**, 处于LISTEN(收听)状态, 等待连接请求. 客户端同样创建 **传输控制块TCB**.  
1. 建立连接时, 客户端发送 连接请求报文段, 首部 SYN(同步位) = 1, seq(序号) = x(随机). 此报文段不携带数据(ACK=0).  
2. 服务器端为该TCP连接分配缓存, 并返回 确认报文段, SYN = 1, ACK = 1, seq = y, ack = x+1. 此报文段不携带数据.  
3. 客户进程收到确认后, 还要服务器发送确认, SYN = 0, ACK = 1, ack = y+1, seq = x+1. 可以携带数据.  

> 为什么客户进程需要对服务器的确认进行确认?  
> 当客户A发送请求时, 如果因为延迟等收不到服务器B的确认, A就可能再次发送请求.  
> B收到两次请求可能会建立两个连接. 但A已经放弃了第一次连接, B却不知道.  
> 所以需要第三次的确认.  


<span style="color:blue">TCP连接的释放</span>(四次握手):  
![TCP连接的释放](../../image/计算机网络/TCP连接的释放.png)  

数据传输结束后, 通信双方都可以释放连接.  
1. 客户端发送 连接释放报文段, 并停止发送数据, 主动关闭TCP连接. FIN = 1, seq = u.  
2. 服务器回送 确认报文段, seq = v, ack = u+1. 此时TCP连接处于 **半关闭** 状态, 服务器仍可以发送数据.  
3. 服务器端发完数据后, 会发送 连接释放报文段, FIN = 1, ack = u+1.  
4. 客户端收到后会发送确认报文段, seq = u+1. 其后会等待 2MSL 后关闭.  
> MSL: 最长报文段寿命, 设置2MSL是为了确保最后的ACK报文段能够到达服务器端B, 如果B收不到确认, 默认丢失, 进行超时重传.  


### 可靠传输与流量控制


TCP通信的双方都有自己的发送窗口与接收窗口.  

流量控制与可靠传输:  
[流量控制与可靠传输机制☆](#流量控制与可靠传输机制☆)  

**滑动窗口以字节为单位**  

在通信过程中, 接收方可以根据自己接收缓存的大小, 动态地调整接收窗口(rwnd)的大小.  
并通知对方自己的rwnd大小(TCP报文有个窗口字段).  
发送方会根据收到的信息调整自己的发送窗口大小.  

当rwnd为0时, 表示无接收缓存, 即不允许发送方再发送数据, 直到接收方发送非零的窗口的通知.  
如果通知丢失, 会导致双方都陷入等待, 所以当TCP连接的一方收到零窗口的通知, 就启动 **持续计时器**, 计时结束会发送 **探测报文段**, 对方会回复此时的窗口值, 仍为零则重置计时.  


### TCP拥塞控制


计算机网络中的链路容量(即带宽), 交换节点的缓存和处理机等都是网络的资源.  
当资源的需求超过其能提供的可用部分, 就会网络的性能降低, 即出现**拥塞**.  

流量控制与拥塞控制的关系密切, 但并不完全相同.  
拥塞控制需要**防止过多的数据注入到网络中**, 使网络中的路由器或链路不至于过载. 为网络的**全局性**问题.  
流量控制一般指**点对点通信量的控制**, 是**端到端**的问题.  

**拥塞控制方法**:  

- 慢开始与拥塞避免:  
	发送方维持一个**拥塞窗口(cwnd)**, 取决于网络的拥塞程度进行动态变化.  
	发送方让自己的**发送窗口等于拥塞窗口**.  
	当出现超时重传时, 发送方即判断网络出现拥塞, 需要减小拥塞窗口.  
	
	- 慢开始:  
		由小到大逐渐增大注入到网络中的数据, 即**由小到大逐渐增大拥塞窗口值**.  
		拥塞窗口初始值为1或2个发送方的 **最大报文段(SMSS)** 的长度.  
		- <span style="color:red">为方便叙述, 用报文段的个数作为窗口大小的单位.</span>  
		先设置cwnd = 1, 发送方每收到一个**对新报文段的确认**, 拥塞窗口加 1.  
		即每经过一个往返时延RTT后, cwnd翻倍.  
		为避免过度增长, 还需设置一个 **慢开始门限(ssthresh)**.  
		当cwnd超过门限时开始使用**拥塞避免算法**.  
	- 拥塞避免:  
		每经过一个往返时延RTT, 发送方的拥塞窗口加 1.  
		即开始线性增长, 而不是指数增长.  
		当拥塞发生时, 将慢开始门限ssthresh设置为拥塞窗口的一半.  
		并将拥塞窗口重置为1.  

![拥塞控制](../../image/计算机网络/拥塞控制.png)
> 一个传输轮次即一个往返时延RTT.  

- 快重传和快恢复:  
	快重传即让发送方**尽早知道发生了个别报文段的丢失**.  
	其要求接收方在接收后**立即发送确认**, 收到失序报文时发送之前的重复确认.  
	当发送方连续收到三个重复确认, 就判断并未出现网络拥塞, 并立即进行重传.  
	其并不会启动慢开始算法, 而是快恢复算法.  
	
	快恢复即 ssthresh = cwnd / 2, cwnd /= 2.  


发送方的发送窗口为 min\[rwnd, cwnd].  



# 应用层


应用层对对应用程序的通信提供服务, 具体为定义应用之间的通信规则.  
- 应用进程交换的报文类型.  
- 各种报文类型的语法.  
- 字段的语义.  
- 进程何时、如何发送报文, 以及如何响应报文.  

层应用层的许多协议都是基于**客户服务器**方式.  
**客户**(进程)是服务**请求方**, **服务器**(进程)是服务**提供方**.  


## 域名系统DNS


域名系统DNS 是互联网使用的命名系统, 用来将网站(主机)的域名(网址)转换为IP地址.  

互联网的相互通信需要知道其IP地址, 但为了方便记忆, 将其替换为不重复的域名(网址的名字).  
域名系统DNS 负责将域名转为IP地址. 这一过程也称为 **域名解析**.  


### 域名的结构


域名由 **标号(label)** 序列组成, 标号之间用点隔开.  
例: `www.bilibili.com`: 从左到右，依次为三级域名,二级域名,顶级域名.  
域名中的标号都由英文字母和数字组成, 每一个标号不超过63个字符(最好不要超过12个字符), 也不区分大小写.  

- 顶级域名(nTLD):  
	- 国家顶级域名: 如 cn(中国), us(美国), uk(英国), 已超过300个.  
	- 通用顶级域名: com(公司企业), net(网络服务机构), org(非盈利性组织), int(国际组织)... 
	- 基础结构域名: 只有一个, arpa. 用于反向域名解析, 因此又称反向域名.  

- 二级域名:  
	在国家顶级域名下注册的二级域名均由该国家自行确定.  
	我国将二级域名划分为 "类别域名" 和 "行政区域名" 两大类.  
	- 类别域名: ac(科研机构), com(工, 商, 金融等企业), edu(教育机构), gov(政府机构), mil(国防机构), net(互联网服务机构), org.  

- 三级及以下:  
	在某个二级域名下注册的单位就可以获得一个三级域名.  
	当某个单位拥有了一个域名, 它就可以自己决定是否要进一步划分其下属的子域, 并且不必由其上级机构批准.  


### 域名服务器


一个服务器所负责管辖的范围叫做**区(zone)**.  
每一个区设置相应的权限域名服务器, 用来保存该区中的所有主机的域名到IP地址的映射.  
区的范围 小于等于 域.  

域名服务器可以划分为四类:  

- 根域名服务器:  
	其为最高层次的域名服务器, 也是最重要的域名服务器.  
	所有的根域名服务器都知道所有的顶级域名服务器的域名和IP地址.  
	全世界的根域名服务器只使用13个不同的IP地址的域名, (a-m).rootservers.net  
	2021-3-24, 全球共有1375个根服务器在运行, 我国共有37个.  

- 顶级域名服务器:  
	负责管理在该顶级域名服务器注册的所有二级域名.  

- 权限域名服务器:  
	负责一个区的域名服务器.  

- 本地域名服务器:  
	当一台主机发出DNS查询请求时, 这个查询请求报文就发送给本地域名服务器.  
	其离用户较近. 当所要查询的主机也属于同一个本地ISP时, 该本地域名服务器立即就能将所查询的主机名转换为它的IP地址, 而不需要再去查询其他的域名服务器.  


### 域名解析过程


主机向本地域名服务器的查询一般都采用**递归查询**, 本地服务器向根域名服务器的查询通常采用**迭代查询**.  

- 递归查询:  
	如果主机所询问的本地服务器不知道被查询域名的IP地址. 那么本地域名服务器就以DNS客户的身份向其他域名服务器继续发出查询请求报文. 而不是让该主机自己进行下一步的查询.  

- 迭代查询:  
	当根域名服务器收到本地域名服务器发出的迭代查询请求报文时. 要么给出所查询的IP地址, 要么告诉本地服务域名服务器应该去找哪个下一个域名服务器.  

<span style="color:blue">域名解析过程</span>:  
![域名解析过程](../../image/计算机网络/域名解析过程.png)


## 文件传送协议FTP


文件传送协议FTP曾是互联网上使用最广泛的文件传送协议.  
其提供不同类型的主机系统间的文件传输能力.  

FTP使用客户服务器的方式, 服务器由两大部分组成:  
- 主进程: 负责接受新的请求.  
- 从属进程: 负责处理单个请求.  

服务器中有两个从属进程: **控制进程**和**数据传送进程**.  
在进行文件传输时，FTP的客户和服务器之间要建立两个并行的TCP连接: **控制连接**和**数据连接**.  
控制连接在会话期间会一直保持打开, 客户发出的传送请求, 通过控制连接发给 "控制进程". 控制进程随之创建 "数据传送进程" 和 "数据连接", 完成数据的传送, 之后会释放连接, 关闭进程.  
两个TCP连接使用的是不同的端口号, 控制连接(21), 数据连接(20).  


## 电子邮件


电子邮件由 **信封** 和 **内容** 两部分组成.  
电子邮件地址的格式: **用户名 @ 邮件服务器的域名**  


简单邮件传送协议SMTP.  
一个邮件系统由三个主要组件构成: 用户代理, 邮件服务器, 邮件发送协议.  

![电子邮件系统](../../image/计算机网络/电子邮件系统.png)  

- 用户代理UA:  
	用户与电子邮件系统的接口, 一般为运行在用户计算机中的一个程序. 又称 电子邮件客户端软件.  
	负责提供友好的接口(窗口界面)来发送和接收邮件.  
	用户代理的功能: 撰写, 显示, 处理, 通信.  

- 邮件服务器:  
	有着大容量的邮件信箱. 其功能为发送和接收邮件, 并向发件人报告邮件传送结果.  
	其使用两种不同的协议:  
	一种用于用户代理向邮件服务器 或 邮件服务器之间 发送邮件, 如SMTP.  
	一种用于用户代理从服务器读取邮件, 如POP3.  


- ＳＭＴＰ:  
	SMTP使用客户服务器的方式, STMP进程既可以是客户, 也可以是服务器.  
	SMTP规定了14条命令和21种应答信息. 每条命令只有几个字母, 每种应答信息只有一行.  
	1. 连接建立:  
		发件人的邮件发送到发送方邮件服务器的邮件缓存后, SMTP客户就每隔一定时间对缓存扫描一次. 如果有邮件, 就使用25端口号与接收方建立TCP连接.  
		
		接收方会发出 "220 Service ready"  
		发送方回复 "HELO"命令, 附上主机名  
		...
		...
	2. 邮件发送:  
		从MAIL命令开始, MAIL FROM: <...\@...>  
		...
	3. 连接释放:  
		客户发送QUIT命令, 服务器返回221, 传送结束.  

- POP3:  
	邮局协议, 非常简单, 功能有限的邮件读取协议.  
	使用客户服务器的工作方式, 其有一个特点:  
	用户从POP3服务器读取了邮件后, 服务器会将其删除.  

- IMAP:  
	另一个比较复杂的邮件读取协议.  
	用户可以在不同的地方使用不同的计算机随时上网查看邮件. 还允许只读取邮件中的一部分, 暂时搁置附件等其他内容.  


## 万维网


万维网ｗｗｗ(world wide web)是一个大规模的, 联机式的信息储存所, 简称Web. 是无数个网络站点和网页的集合.  

万维网使用 **统一资源定位符URL** 来标志万维网上的各种文档.  
万维网客户与服务器使用 HTTP(超文本传送协议) 进行交互, 采用TCP连接.  
页面的设计使用 超文本标记语言HTML.  

- URL:  
	一般形式: 协议://主机名 :端口(通常省略) /路径  
	主机名为存放文档的主机的**域名**, 通常以www开头.  
	端口号一般为80, 因此 :80 可以省略.  


### HTTP

